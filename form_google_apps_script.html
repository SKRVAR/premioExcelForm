<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postulaci칩n Premio Excelencia - UNCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .title-font {
            font-family: 'Montserrat', sans-serif;
        }
        
        pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .hidden {
            display: none;
        }
        
        .gradient-gold {
            background: #d4af37; /* Dorado oscuro institucional */
        }
        
        .border-teal {
            border-color: rgba(13, 132, 105, 0.6);
        }
        
        .bg-dark-teal {
            background: rgba(13, 132, 105, 0.05);
        }
        
        .text-gold {
            color: #d4af37; /* Dorado oscuro institucional */
        }
        
        .btn-gold {
            background: #d4af37; /* Dorado oscuro institucional */
            border: 2px solid rgba(13, 132, 105, 0.6);
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            background: rgba(13, 132, 105, 0.9); /* Verde oscuro institucional */
            border-color: rgba(13, 132, 105, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 132, 105, 0.4);
        }
        
        .countdown-container {
            background: transparent;
            border: none;
        }
        
        .countdown-number {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #1e40af;
            font-size: 1.75rem;
        }
        
        .countdown-label {
            font-size: 0.65rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-top {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .btn-nav {
            background: white;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-nav:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .btn-nav-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f0c44d 100%);
            border: none;
            color: white;
        }
        
        .btn-nav-primary:hover {
            background: linear-gradient(135deg, #c09a2a 0%, #d4af37 100%);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, rgba(13, 132, 105, 0.1) 0%, rgba(212, 175, 55, 0.1) 100%);
            border-radius: 999px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, rgba(13, 132, 105, 0.8) 0%, rgba(212, 175, 55, 0.8) 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Banner de ampliaci칩n excepcional */
        .banner-extension {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-icon {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-gray-800 flex items-center justify-center min-h-screen p-3 md:p-6">

    <!-- Barra de navegaci칩n superior -->
    <div class="nav-top fixed top-0 left-0 right-0 z-50 py-3">
        <div class="max-w-4xl mx-auto px-4 md:px-6">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <!-- Botones de navegaci칩n -->
                <div class="flex gap-2">
                    <a href="index.html" class="btn-nav">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        P치gina Principal
                    </a>
                    <a href="./recursos/BasesPrmExcelencia.pdf" target="_blank" class="btn-nav">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Ver Bases
                    </a>
                    <a href="index.html#faq" target="_blank" class="btn-nav">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Ayuda/FAQ
                    </a>
                </div>
                
                <!-- Contador regresivo minimalista -->
                <div id="countdownContainer" class="countdown-container flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-medium hidden md:inline">Cierre en:</span>
                    </div>
                    <div id="countdown" class="flex gap-2">
                        <div class="text-center">
                            <div id="days" class="countdown-number">--</div>
                            <div class="countdown-label">D칤as</div>
                        </div>
                        <div class="text-gray-300 countdown-number self-start">:</div>
                        <div class="text-center">
                            <div id="hours" class="countdown-number">--</div>
                            <div class="countdown-label">Hrs</div>
                        </div>
                        <div class="text-gray-300 countdown-number self-start">:</div>
                        <div class="text-center">
                            <div id="minutes" class="countdown-number">--</div>
                            <div class="countdown-label">Min</div>
                        </div>
                        <div class="text-gray-300 countdown-number self-start">:</div>
                        <div class="text-center">
                            <div id="seconds" class="countdown-number">--</div>
                            <div class="countdown-label">Seg</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Espaciador para compensar la barra fija -->
    <div class="h-20"></div>

    <div class="w-full max-w-4xl mx-auto bg-white/95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200 p-4 md:p-6">
        
        <!-- Encabezado -->
        <div class="text-center mb-5 -mx-4 md:-mx-6 -mt-4 md:-mt-6 px-4 py-5 rounded-t-lg border-b-2 border-teal" style="background: #d4af37;">
            <h1 class="title-font text-xl md:text-2xl font-bold text-white tracking-tight">II Premio a la Excelencia Cient칤fica UNCP 2025</h1>
            <p class="text-gray-200 mt-1 text-sm font-medium">Formulario de Postulaci칩n</p>
        </div>
        
        <!-- Banner de Ampliaci칩n Excepcional -->
        <div class="banner-extension rounded-lg p-3 mb-5 shadow-sm">
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-amber-600 pulse-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="flex-grow">
                    <p class="text-sm font-bold text-amber-900 mb-1 flex items-center gap-2">
                        <span>游꿀 춰AMPLIACI칍N EXCEPCIONAL!</span>
                    </p>
                    <p class="text-xs text-amber-800 leading-relaxed">
                        El plazo para presentar postulaciones se ha <strong>extendido hasta el 30 de noviembre de 2025 a las 23:59 horas (hora de Per칰)</strong>. 춰A칰n est치s a tiempo de participar!
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Indicador de Progreso -->
        <div id="progressIndicator" class="mb-6 hidden">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-medium text-gray-600">Progreso de postulaci칩n</span>
                <span id="progressText" class="text-xs font-semibold text-gray-700">Paso 1 de 3</span>
            </div>
            <div class="progress-bar h-2">
                <div id="progressFill" class="progress-fill" style="width: 33.33%"></div>
            </div>
        </div>

        <!-- CONFIGURACI칍N: Cambiar por tu URL del Web App -->
        <script>
            // 丘멆잺 IMPORTANTE: Reemplaza esta URL con la de tu Google Apps Script Web App
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyp_jsEExL8tpwKsLG9g8LnvcYq5mD_FdesKLGZy8NxQGLpNIyUY_IH6gH3yBZ3ywSK-w/exec';
            
            // 丘멆잺 FECHA L칈MITE DE POSTULACI칍N (Hora de Per칰 UTC-5)
            // Formato: A침o, Mes (0-11), D칤a, Hora, Minuto, Segundo
            const FECHA_LIMITE = new Date(2025, 10, 30, 23, 59, 59); // 30 de noviembre 2025, 23:59:59 - AMPLIACI칍N EXCEPCIONAL
        </script>

        <!-- SECCI칍N 1: B칰squeda de publicaci칩n -->
        <div id="seccionBusqueda" class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="title-font text-lg font-semibold text-gray-800 border-l-4 border-teal pl-3">1. Datos de la Publicaci칩n</h2>
                <div class="tooltip">
                    <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <span class="tooltiptext">Ingrese el DOI para obtener autom치ticamente los datos del art칤culo. Si no tiene DOI, puede ingresar los datos manualmente.</span>
                </div>
            </div>
            
            <!-- Informaci칩n sobre el DOI -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <div class="flex gap-2">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zm-11-1a1 1 0 11-2 0 1 1 0 012 0zM8 8a1 1 0 000 2h6a1 1 0 000-2H8zm0 3a1 1 0 000 2h3a1 1 0 000-2H8z" clip-rule="evenodd" />
                    </svg>
                    <div class="flex-grow">
                        <p class="text-sm font-semibold text-blue-900 mb-1">Ingrese el DOI del art칤culo</p>
                        <p class="text-xs text-blue-800">El DOI (Identificador de Objeto Digital) es un c칩digo 칰nico que identifica su art칤culo cient칤fico. Al ingresarlo, el sistema obtendr치 autom치ticamente todos los metadatos: t칤tulo, autores, revista, editorial y fecha de publicaci칩n.</p>
                    </div>
                </div>
            </div>
            
            <form id="doiForm" class="flex flex-col sm:flex-row gap-2 mb-4">
                <input 
                    type="text" 
                    id="doiInput" 
                    placeholder="Ej: 10.1038/s41586-021-03590-y o 10.1145/3456789" 
                    class="flex-grow w-full px-3 py-2 text-sm bg-white border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all duration-200" 
                    required
                >
                <button 
                    type="submit" 
                    class="btn-gold text-white font-semibold px-5 py-2 text-sm rounded focus:outline-none focus:ring-2 focus:ring-amber-500"
                >
                    Obtener Metadatos
                </button>
            </form>

            <div class="flex justify-end mb-4 -mt-2">
                <button 
                    type="button" 
                    onclick="iniciarIngresoManual()"
                    class="text-xs text-gray-600 hover:text-amber-700 hover:underline font-medium flex items-center gap-1"
                >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    쯅o cuenta con un DOI? Ingrese los datos manualmente
                </button>
            </div>

            <!-- Contenedor de Resultados -->
            <div id="resultado" class="mt-4 space-y-3">
                <div class="text-center text-gray-500 p-6 border border-dashed border-gray-300 rounded bg-gray-50/50">
                    <p class="text-sm">Los resultados de la b칰squeda aparecer치n aqu칤.</p>
                </div>
            </div>
        </div>

        <!-- SECCI칍N 2: Datos del postulante (oculta inicialmente) -->
        <div id="seccionPostulante" class="hidden mb-6">
            <h2 class="title-font text-lg font-semibold mb-3 text-gray-800 border-l-4 border-teal pl-3 border-t pt-4 mt-4">2. Datos del Postulante</h2>
            
            <form id="formularioPostulacion" class="space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombres *</label>
                        <input type="text" id="nombres" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Apellidos *</label>
                        <input type="text" id="apellidos" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="ejemplo@uncp.edu.pe">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Declaraci칩n Jurada (PDF, Anexo 03) *</label>
                    <input 
                        type="file" 
                        id="pdfDeclaracionJurada" 
                        accept=".pdf"
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-amber-50 file:text-gray-700 hover:file:bg-amber-100"
                    >
                    <p class="text-xs text-gray-500 mt-1">M치ximo 10 MB. Solo se acepta en PDF. Anexo 03 de las bases del evento. <a href="recursos/anexoIII_prmExcelencia.docx" download class="text-blue-600 hover:text-blue-800 hover:underline font-medium">Click aqu칤 para descargar el Anexo 03</a></p>
                </div>

                <!-- Campos ocultos para datos de la publicaci칩n -->
                <input type="hidden" id="publicacionTitulo">
                <input type="hidden" id="publicacionAutores">
                <input type="hidden" id="publicacionDOI">
                <input type="hidden" id="publicacionRevista">
                <input type="hidden" id="publicacionEditorial">
                <input type="hidden" id="publicacionFecha">
                <input type="hidden" id="publicacionMetadatos">
                <input type="hidden" id="pdfDeclaracionJuradaId">
                <input type="hidden" id="pdfDeclaracionJuradaUrl">

                <!-- Botones de navegaci칩n -->
                <div class="flex gap-2 pt-4">
                    <button 
                        type="button"
                        onclick="if(confirm('쮼st치 seguro de cancelar? Se perder치n los datos ingresados.')) window.location.href='index.html'"
                        class="bg-red-600 text-white font-medium text-sm px-4 py-2 rounded hover:bg-red-700 transition"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="button"
                        onclick="volverBusqueda()"
                        class="flex-1 bg-gray-700 text-white font-medium text-sm px-4 py-2 rounded hover:bg-gray-800 transition border border-gray-600"
                    >
                        Volver
                    </button>
                    <button 
                        type="button"
                        onclick="continuarAutores()"
                        class="flex-1 btn-gold text-white font-semibold text-sm px-4 py-2 rounded"
                    >
                        Continuar
                    </button>
                </div>
            </form>
        </div>

        <!-- SECCI칍N 3: Autores del Art칤culo (oculta inicialmente) -->
        <div id="seccionAutores" class="hidden mb-6">
            <div class="flex items-center justify-between mb-3 border-t pt-4 mt-4">
                <h2 class="title-font text-lg font-semibold text-gray-800 border-l-4 border-teal pl-3">3. Autores del Art칤culo</h2>
                <div class="tooltip">
                    <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <span class="tooltiptext">Complete la informaci칩n de cada autor. Al menos un autor debe tener afiliaci칩n o v칤nculo vigente con la UNCP.</span>
                </div>
            </div>
            <div class="bg-dark-teal border border-teal rounded p-3 mb-3">
                <p class="text-xs text-gray-700 mb-2 font-medium">Para cada autor, indique:</p>
                <ul class="text-xs text-gray-600 ml-4 space-y-1 list-disc">
                    <li><span class="font-medium">Afiliaci칩n declarada:</span> Instituci칩n que aparece en el art칤culo</li>
                    <li><span class="font-medium">V칤nculo con la UNCP vigente:</span> Relaci칩n actual con la UNCP (adjuntar PDF si es UNCP: Resoluci칩n, contrato, ficha de matr칤cula - Opcional)</li>
                    <li><span class="font-medium">Autor corresponsal:</span> Marque si aparece como corresponsal</li>
                </ul>
            </div>
            
            <div id="listaAutores" class="space-y-2">
                <!-- Los autores se generar치n din치micamente aqu칤 -->
            </div>

        </div>

        <!-- BOT칍N DE ENV칈O FINAL -->
        <div id="seccionEnvio" class="hidden mb-6">
            <div class="flex gap-2 pt-3 border-t border-gray-200 mt-4">
                <button 
                    type="button"
                    onclick="if(confirm('쮼st치 seguro de cancelar? Se perder치n los datos ingresados.')) window.location.href='index.html'"
                    class="bg-red-600 text-white font-medium text-sm px-4 py-2 rounded hover:bg-red-700 transition"
                >
                    Cancelar
                </button>
                <button 
                    type="button"
                    onclick="volverDatosPostulante()"
                    class="flex-1 bg-gray-700 text-white font-medium text-sm px-4 py-2 rounded hover:bg-gray-800 transition border border-gray-600"
                >
                    Volver
                </button>
                <button 
                    type="button"
                    onclick="enviarPostulacion()"
                    id="btnEnviar"
                    class="flex-1 btn-gold text-white font-semibold text-sm px-4 py-2 rounded"
                >
                    Enviar Postulaci칩n
                </button>
            </div>
        </div>

        <!-- Mensaje de 칠xito -->
        <div id="mensajeExito" class="hidden bg-gradient-to-r from-emerald-50 to-teal-50 border-l-4 border-teal text-gray-800 p-4 rounded mt-3">
            <p class="title-font font-bold text-base">Postulaci칩n enviada exitosamente</p>
            <p class="mt-1.5 text-sm text-gray-700">Recibir치 una confirmaci칩n en su correo electr칩nico con los detalles de su postulaci칩n.</p>
            <button 
                onclick="nuevaPostulacion()"
                class="mt-3 btn-gold text-white px-4 py-2 text-sm rounded font-medium"
            >
                Nueva Postulaci칩n
            </button>
        </div>

    </div>

    <!-- Modal de progreso centrado -->
    <div id="modalProgreso" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center">
                <!-- 칈cono animado -->
                <div class="mx-auto w-16 h-16 mb-4 relative">
                    <svg class="animate-spin h-16 w-16 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                
                <!-- T칤tulo -->
                <h3 class="title-font text-xl font-bold text-gray-800 mb-2">Enviando Postulaci칩n</h3>
                <p id="progressText" class="text-sm text-gray-600 mb-4">Preparando datos...</p>
                
                <!-- Barra de progreso -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden">
                    <div id="progressBar" class="h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%; background: linear-gradient(90deg, #d4af37 0%, #f59e0b 100%);"></div>
                </div>
                <p id="progressPercent" class="text-xs text-gray-500 font-medium">0%</p>
                
                <!-- Mensaje informativo -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-xs text-blue-800">
                        <strong>Por favor espere.</strong> No cierre ni actualice esta ventana.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variable global para almacenar los metadatos completos
        let metadatosPublicacion = null;
        let autoresArticulo = [];

        /**
         * Verifica si la fecha l칤mite de postulaci칩n ha pasado
         */
        function verificarFechaLimite() {
            const ahora = new Date();
            return ahora > FECHA_LIMITE;
        }

        /**
         * Muestra mensaje de formulario cerrado
         */
        function mostrarFormularioCerrado() {
            const fechaFormateada = FECHA_LIMITE.toLocaleDateString('es-PE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Ocultar todas las secciones del formulario
            const secciones = ['seccionBusqueda', 'seccionPostulante', 'seccionAutores', 'seccionEnvio'];
            secciones.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.classList.add('hidden');
            });

            // Crear y mostrar mensaje de cierre
            const contenedor = document.querySelector('.max-w-4xl');
            if (contenedor) {
                // Mantener solo el encabezado y agregar el mensaje
                const encabezado = contenedor.querySelector('.text-center.mb-5');
                contenedor.innerHTML = '';
                if (encabezado) contenedor.appendChild(encabezado);
                
                const mensajeCierre = document.createElement('div');
                mensajeCierre.className = 'bg-gradient-to-br from-red-50 to-orange-50 border-2 border-red-300 rounded-xl p-6 md:p-8';
                mensajeCierre.innerHTML = `
                    <div class="flex flex-col items-center text-center">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-5">
                            <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        
                        <h2 class="title-font text-2xl md:text-3xl font-bold text-red-900 mb-3">Plazo de Postulaci칩n Finalizado</h2>
                        
                        <p class="text-base text-gray-700 mb-4 leading-relaxed max-w-2xl">
                            El per칤odo de postulaci칩n para el <strong>II Premio a la Excelencia Cient칤fica UNCP 2025</strong> concluy칩 el <strong class="text-red-700">${fechaFormateada}</strong>.
                        </p>
                        
                        <div class="bg-white rounded-lg p-5 border border-red-200 mb-5 w-full">
                            <p class="text-sm text-gray-600 mb-3">
                                <svg class="w-5 h-5 text-blue-600 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zm-11-1a1 1 0 11-2 0 1 1 0 012 0zM8 8a1 1 0 000 2h6a1 1 0 000-2H8zm0 3a1 1 0 000 2h3a1 1 0 000-2H8z" clip-rule="evenodd"></path>
                                </svg>
                                <strong>Agradecemos su inter칠s</strong>
                            </p>
                            <p class="text-sm text-gray-700 leading-relaxed">
                                Le invitamos a estar atento a futuras convocatorias del Premio a la Excelencia Cient칤fica de la Universidad Nacional del Centro del Per칰.
                            </p>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 w-full">
                            <p class="text-xs text-blue-900 font-medium mb-2">Para m치s informaci칩n, puede contactar a:</p>
                            <p class="text-sm text-blue-800">
                                <strong>Instituto General de Investigaci칩n - UNCP</strong><br>
                                Email: <a href="mailto:investigacion@uncp.edu.pe" class="hover:underline font-medium">investigacion@uncp.edu.pe</a>
                            </p>
                        </div>
                        
                        <a href="index.html" class="mt-6 inline-flex items-center gap-2 px-6 py-3 text-white font-semibold rounded-lg transition-all btn-gold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Volver a la p치gina principal
                        </a>
                    </div>
                `;
                contenedor.appendChild(mensajeCierre);
            }
        }

        /**
         * Actualiza el contador regresivo y bloquea el formulario si expira
         */
        function actualizarContador() {
            const ahora = new Date();
            const diferencia = FECHA_LIMITE - ahora;
            
            if (diferencia <= 0) {
                document.getElementById('countdown').innerHTML = '<span class="text-red-600 font-bold text-sm">Plazo finalizado</span>';
                
                // Bloquear el formulario inmediatamente
                if (!document.getElementById('seccionBusqueda').classList.contains('hidden') || 
                    !document.getElementById('seccionPostulante').classList.contains('hidden') ||
                    !document.getElementById('seccionAutores').classList.contains('hidden')) {
                    mostrarFormularioCerrado();
                }
                return;
            }
            
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diferencia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
            const segundos = Math.floor((diferencia % (1000 * 60)) / 1000);
            
            document.getElementById('days').textContent = String(dias).padStart(2, '0');
            document.getElementById('hours').textContent = String(horas).padStart(2, '0');
            document.getElementById('minutes').textContent = String(minutos).padStart(2, '0');
            document.getElementById('seconds').textContent = String(segundos).padStart(2, '0');
        }
        
        /**
         * Actualiza el indicador de progreso
         */
        function actualizarProgreso(paso) {
            const progressIndicator = document.getElementById('progressIndicator');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressIndicator.classList.remove('hidden');
            
            const pasos = {
                1: { width: '33.33%', text: 'Paso 1 de 3: Datos de la Publicaci칩n' },
                2: { width: '66.66%', text: 'Paso 2 de 3: Datos del Postulante' },
                3: { width: '100%', text: 'Paso 3 de 3: Autores del Art칤culo' }
            };
            
            if (pasos[paso]) {
                progressFill.style.width = pasos[paso].width;
                progressText.textContent = pasos[paso].text;
            }
        }

        /**
         * Inicializa la verificaci칩n de fecha l칤mite al cargar la p치gina
         */
        (function inicializarFormulario() {
            if (verificarFechaLimite()) {
                mostrarFormularioCerrado();
            } else {
                // Iniciar contador regresivo
                actualizarContador();
                setInterval(actualizarContador, 1000);
                
                // Mostrar progreso inicial
                actualizarProgreso(1);
            }
        })();

        /**
         * Muestra el modal de progreso
         */
        function mostrarModalProgreso(mensaje = 'Preparando...', porcentaje = 0) {
            document.getElementById('modalProgreso').classList.remove('hidden');
            actualizarProgreso(mensaje, porcentaje);
        }

        /**
         * Oculta el modal de progreso
         */
        function ocultarModalProgreso() {
            document.getElementById('modalProgreso').classList.add('hidden');
            actualizarProgreso('Preparando...', 0);
        }

        /**
         * Actualiza el texto y porcentaje del progreso
         */
        function actualizarProgreso(mensaje, porcentaje) {
            document.getElementById('progressText').textContent = mensaje;
            document.getElementById('progressBar').style.width = porcentaje + '%';
            document.getElementById('progressPercent').textContent = porcentaje + '%';
        }

        /**
         * Formatea un valor para mostrarlo en la tabla
         */
        function formatDisplayValue(value, depth = 0) {
            if (value === null || value === undefined) {
                return '<span class="text-gray-500">N/A</span>';
            }

            if (depth > 5) {
                return '[Demasiado anidado para mostrar]';
            }

            if (Array.isArray(value)) {
                if (value.every(item => typeof item !== 'object' || item === null)) {
                    return value.join(', ');
                }
                
                let listHtml = '<ul class="list-disc list-inside space-y-1 mt-1">';
                value.forEach(item => {
                    listHtml += `<li>${formatDisplayValue(item, depth + 1)}</li>`;
                });
                listHtml += '</ul>';
                return listHtml;
            }

            if (typeof value === 'object') {
                let objectParts = [];
                
                if (('given' in value || 'family' in value) && Object.keys(value).length < 5) {
                     return `${value.given || ''} ${value.family || ''}`.trim();
                }

                for (const [key, val] of Object.entries(value)) {
                    objectParts.push(`<div><strong class="font-medium text-gray-700">${key}:</strong> ${formatDisplayValue(val, depth + 1)}</div>`);
                }
                return `<div class="space-y-1">${objectParts.join('')}</div>`;
            }
            
            return `<span class="text-gray-800">${value}</span>`;
        }

        /**
         * Renderiza todos los metadatos en una tabla HTML
         */
        function renderAllMetadataAsTable(metadata) {
            let tableHtml = '<div class="border border-gray-200 rounded-lg overflow-hidden"><table class="w-full text-sm">';
            tableHtml += '<thead class="bg-gray-50"><tr class="text-left"><th class="px-4 py-2 font-semibold">Campo (Metadato)</th><th class="px-4 py-2 font-semibold">Valor</th></tr></thead>';
            tableHtml += '<tbody>';

            for (const [key, value] of Object.entries(metadata)) {
                tableHtml += '<tr class="border-t border-gray-200">';
                tableHtml += `<td class="px-4 py-2 align-top font-medium text-gray-600">${key}</td>`;
                
                const displayValue = formatDisplayValue(value);

                tableHtml += `<td class="px-4 py-2 align-top">${displayValue}</td>`;
                tableHtml += '</tr>';
            }

            tableHtml += '</tbody></table></div>';
            return tableHtml;
        }

        /**
         * Genera la lista de autores con campos de afiliaci칩n declarada, v칤nculo laboral y autor corresponsal
         */
        function generarListaAutores() {
            const listaAutoresDiv = document.getElementById('listaAutores');
            let html = '';

            autoresArticulo.forEach((autor, index) => {
                const nombreCompleto = `${autor.given || ''} ${autor.family || ''}`.trim() || 'Autor sin nombre';
                
                html += `
                    <div class="border border-gray-300 rounded bg-white/80 backdrop-blur-sm p-3 hover:shadow-md transition-shadow">
                        <div class="flex items-start gap-2">
                            <div class="flex-shrink-0 w-6 h-6 text-white rounded-full flex items-center justify-center text-xs font-bold border border-teal" style="background: #d4af37;">
                                ${index + 1}
                            </div>
                            <div class="flex-grow">
                                <h3 class="title-font font-semibold text-gray-800 mb-2 text-sm">${nombreCompleto}</h3>
                                
                                <div class="space-y-2">
                                    <!-- Afiliaci칩n declarada en el art칤culo -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">
                                            Afiliaci칩n declarada en el Art칤culo *
                                        </label>
                                        <select 
                                            id="afiliacionDeclarada_${index}" 
                                            onchange="toggleCamposUNCP(${index})"
                                            required 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white"
                                        >
                                            <option value="">Seleccione...</option>
                                            <option value="UNCP">UNCP</option>
                                            <option value="EXTERNO">Externo</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Autor Corresponsal (Visible para TODOS los autores) -->
                                    <div>
                                        <div class="flex items-start gap-2">
                                            <input 
                                                type="checkbox" 
                                                id="autorCorresponsal_${index}" 
                                                onchange="manejarSeleccionCorresponsal(${index})"
                                                class="mt-0.5 h-3 w-3 text-amber-600 border-gray-300 rounded focus:ring-amber-500"
                                            >
                                            <label for="autorCorresponsal_${index}" class="block text-xs font-medium text-gray-700">
                                                Es autor corresponsal
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Campos adicionales para UNCP (inicialmente ocultos) -->
                                    <div id="camposUNCP_${index}" class="hidden space-y-2">
                                        
                                        <!-- V칤nculo laboral vigente -->
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">
                                                V칤nculo con la UNCP vigente *
                                            </label>
                                            <select 
                                                id="vinculoLaboral_${index}" 
                                                onchange="togglePdfUpload(${index})"
                                                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white"
                                            >
                                                <option value="">Seleccione...</option>
                                                <option value="UNCP">UNCP</option>
                                                <option value="EXTERNO">Externo</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Campo de PDF para v칤nculo laboral UNCP -->
                                        <div id="pdfContainer_${index}" class="hidden">
                                            <label class="block text-xs font-medium text-gray-700 mb-1">
                                                Documento de v칤nculo UNCP (PDF) (Opcional, se solicitar치 en fases posteriores)
                                                <a href="index.html#faq-vinculo" target="_blank" class="ml-1 text-blue-600 hover:text-blue-800 hover:underline font-normal" title="Ver tipos de documentos aceptados">
                                                    (쯈u칠 documentos se aceptan?)
                                                </a>
                                            </label>
                                            <input 
                                                type="file" 
                                                id="pdfAutor_${index}" 
                                                accept=".pdf"
                                                class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-amber-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-medium file:bg-amber-50 file:text-gray-700 hover:file:bg-amber-100"
                                            >
                                            <p class="text-xs text-gray-500 mt-0.5">M치x. 10 MB</p>
                                        </div>
                                        
                                    </div>
                                    
                                    <!-- Mensaje para autores externos -->
                                    <div id="mensajeExterno_${index}" class="hidden">
                                        <div class="bg-dark-teal border border-teal rounded p-2">
                                            <p class="text-xs text-gray-700">
                                                Autor externo - No se requiere informaci칩n adicional
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            listaAutoresDiv.innerHTML = html;
        }

        /**
         * Muestra/oculta campos adicionales seg칰n la afiliaci칩n declarada
         */
        window.toggleCamposUNCP = function(index) {
            const afiliacionDeclarada = document.getElementById(`afiliacionDeclarada_${index}`).value;
            const camposUNCP = document.getElementById(`camposUNCP_${index}`);
            const mensajeExterno = document.getElementById(`mensajeExterno_${index}`);
            const vinculoLaboral = document.getElementById(`vinculoLaboral_${index}`);
            const pdfContainer = document.getElementById(`pdfContainer_${index}`);
            const pdfInput = document.getElementById(`pdfAutor_${index}`);
            
            if (afiliacionDeclarada === 'UNCP') {
                // Mostrar campos adicionales para UNCP
                camposUNCP.classList.remove('hidden');
                mensajeExterno.classList.add('hidden');
                
                // Hacer campos requeridos
                vinculoLaboral.required = true;
                
            } else if (afiliacionDeclarada === 'EXTERNO') {
                // Ocultar campos adicionales y mostrar mensaje
                camposUNCP.classList.add('hidden');
                mensajeExterno.classList.remove('hidden');
                
                // Limpiar y deshacer campos requeridos
                vinculoLaboral.value = '';
                vinculoLaboral.required = false;
                pdfContainer.classList.add('hidden');
                pdfInput.value = '';
                pdfInput.required = false;
                // NO limpiar el checkbox de corresponsal - puede ser cualquier autor
                
            } else {
                // Si no se ha seleccionado nada, ocultar todo
                camposUNCP.classList.add('hidden');
                mensajeExterno.classList.add('hidden');
                vinculoLaboral.required = false;
            }
        };

        /**
         * Muestra/oculta el campo de PDF seg칰n el v칤nculo laboral seleccionado
         */
        window.togglePdfUpload = function(index) {
            const vinculoLaboral = document.getElementById(`vinculoLaboral_${index}`).value;
            const pdfContainer = document.getElementById(`pdfContainer_${index}`);
            const pdfInput = document.getElementById(`pdfAutor_${index}`);
            
            if (vinculoLaboral === 'UNCP') {
                pdfContainer.classList.remove('hidden');
                pdfInput.required = false;
            } else {
                pdfContainer.classList.add('hidden');
                pdfInput.required = false;
                pdfInput.value = '';
            }
        };

        /**
         * Muestra ventana de confirmaci칩n con resumen de datos
         */
        async function mostrarResumenConfirmacion() {
            return new Promise((resolve) => {
                // Recopilar datos para el resumen
                const titulo = document.getElementById('publicacionTitulo').value;
                const nombrePostulante = `${document.getElementById('nombres').value} ${document.getElementById('apellidos').value}`;
                const emailPostulante = document.getElementById('email').value;
                
                // Generar resumen de autores
                let resumenAutores = '';
                autoresArticulo.forEach((autor, index) => {
                    const nombreCompleto = `${autor.given || ''} ${autor.family || ''}`.trim();
                    const afiliacionDeclarada = document.getElementById(`afiliacionDeclarada_${index}`).value;
                    
                    let detallesAutor = `<div class="border-l-2 border-teal pl-3 mb-2">
                        <p class="font-medium text-gray-800 text-sm">${index + 1}. ${nombreCompleto}</p>
                        <p class="text-xs text-gray-600">Afiliaci칩n: <span class="font-medium">${afiliacionDeclarada === 'UNCP' ? 'UNCP' : 'Externa'}</span></p>`;
                    
                    if (afiliacionDeclarada === 'UNCP') {
                        const vinculoLaboral = document.getElementById(`vinculoLaboral_${index}`).value;
                        const esCorresponsal = document.getElementById(`autorCorresponsal_${index}`).checked;
                        
                        detallesAutor += `<p class="text-xs text-gray-600">V칤nculo: <span class="font-medium">${vinculoLaboral === 'UNCP' ? 'UNCP' : 'Externo'}</span></p>`;
                        
                        if (esCorresponsal) {
                            detallesAutor += `<p class="text-xs text-amber-700 font-medium">Autor corresponsal</p>`;
                        }
                        
                        if (vinculoLaboral === 'UNCP') {
                            const pdfFile = document.getElementById(`pdfAutor_${index}`).files[0];
                            if (pdfFile) {
                                detallesAutor += `<p class="text-xs text-gray-500">PDF: ${pdfFile.name}</p>`;
                            }
                        }
                    }
                    
                    detallesAutor += '</div>';
                    resumenAutores += detallesAutor;
                });
                
                // Crear modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="px-5 py-4 border-b-2 border-teal" style="background: #d4af37;">
                            <h2 class="title-font text-lg font-bold text-white">Confirmaci칩n de Postulaci칩n</h2>
                        </div>
                        <div class="p-5">
                            <div class="space-y-3">
                                <!-- T칤tulo del art칤culo -->
                                <div class="bg-gray-50 border border-gray-200 p-3 rounded">
                                    <h3 class="title-font font-semibold text-gray-800 mb-1 text-sm">T칤tulo del Art칤culo:</h3>
                                    <p class="text-gray-700 text-sm">${titulo}</p>
                                </div>
                                
                                <!-- Datos del postulante -->
                                <div class="bg-dark-teal border border-teal p-3 rounded">
                                    <h3 class="title-font font-semibold text-gray-800 mb-2 text-sm">Postulante:</h3>
                                    <p class="text-gray-700 text-xs"><strong>Nombre:</strong> ${nombrePostulante}</p>
                                    <p class="text-gray-700 text-xs"><strong>Email:</strong> ${emailPostulante}</p>
                                </div>
                                
                                <!-- Autores del art칤culo -->
                                <div class="bg-gray-50 border border-gray-200 p-3 rounded">
                                    <h3 class="title-font font-semibold text-gray-800 mb-2 text-sm">Autores del Art칤culo:</h3>
                                    ${resumenAutores}
                                </div>
                                
                                <!-- Advertencia -->
                                <div class="bg-amber-50 border-l-4 border-amber-500 p-3 rounded">
                                    <p class="text-xs text-gray-800">
                                        <span class="font-semibold">Importante:</span> 
                                        Verifique que todos los datos sean correctos antes de enviar. 
                                        Una vez enviada, la postulaci칩n no podr치 ser modificada.
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Botones -->
                            <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                                <button 
                                    id="btnCancelar" 
                                    class="flex-1 px-4 py-2 text-sm bg-gray-700 text-white rounded hover:bg-gray-800 transition border border-gray-600 font-medium"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    id="btnConfirmar" 
                                    class="flex-1 px-4 py-2 text-sm btn-gold text-white rounded font-semibold"
                                >
                                    Confirmar Env칤o
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Event listeners
                document.getElementById('btnCancelar').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
                
                document.getElementById('btnConfirmar').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                
                // Cerrar con ESC
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        /**
         * Valida que al menos un autor tenga afiliaci칩n UNCP o v칤nculo laboral UNCP
         */
        function validarAlMenosUnAutorUNCP() {
            for (let i = 0; i < autoresArticulo.length; i++) {
                const afiliacionDeclarada = document.getElementById(`afiliacionDeclarada_${i}`).value;
                const vinculoLaboral = document.getElementById(`vinculoLaboral_${i}`).value;
                
                if (afiliacionDeclarada === 'UNCP' || vinculoLaboral === 'UNCP') {
                    return true;
                }
            }
            return false;
        }

        /**
         * Valida que al menos un autor est칠 marcado como corresponsal
         */
        function validarAlMenosUnCorresponsal() {
            for (let i = 0; i < autoresArticulo.length; i++) {
                const esCorresponsal = document.getElementById(`autorCorresponsal_${i}`);
                if (esCorresponsal && esCorresponsal.checked) {
                    return true;
                }
            }
            return false;
        }

        /**
         * Verifica si hay al menos un corresponsal marcado y oculta la advertencia si existe
         */
        function verificarYOcultarAdvertenciaCorresponsal() {
            if (validarAlMenosUnCorresponsal()) {
                const advertenciaExistente = document.getElementById('advertenciaCorresponsal');
                if (advertenciaExistente) {
                    advertenciaExistente.remove();
                }
            }
        }

        /**
         * Maneja la selecci칩n exclusiva de autor corresponsal
         * Solo un autor puede ser corresponsal a la vez
         */
        function manejarSeleccionCorresponsal(indexSeleccionado) {
            const checkboxSeleccionado = document.getElementById(`autorCorresponsal_${indexSeleccionado}`);
            
            // Si se marc칩 este checkbox, desmarcar todos los dem치s
            if (checkboxSeleccionado && checkboxSeleccionado.checked) {
                for (let i = 0; i < autoresArticulo.length; i++) {
                    if (i !== indexSeleccionado) {
                        const otroCheckbox = document.getElementById(`autorCorresponsal_${i}`);
                        if (otroCheckbox) {
                            otroCheckbox.checked = false;
                        }
                    }
                }
            }
            
            // Verificar si se debe ocultar la advertencia
            verificarYOcultarAdvertenciaCorresponsal();
        }

        // ==================================================================
        // FUNCIONES PARA B칔SQUEDA DE DOI EN M칔LTIPLES FUENTES
        // ==================================================================

        /**
         * Busca metadatos del DOI en m칰ltiples fuentes: Crossref, DataCite, OpenAlex
         */
        async function buscarMetadatosDOI(doi) {
            // 1. Intentar con Crossref
            try {
                const crossrefUrl = `https://api.crossref.org/works/${doi}`;
                const response = await fetch(crossrefUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.message) {
                        return {
                            success: true,
                            source: 'Crossref',
                            metadata: normalizarMetadatosCrossref(data.message)
                        };
                    }
                }
            } catch (error) {
                console.log('Crossref fall칩:', error.message);
            }
            
            // 2. Intentar con DataCite
            try {
                const dataciteUrl = `https://api.datacite.org/dois/${doi}`;
                const response = await fetch(dataciteUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.data) {
                        return {
                            success: true,
                            source: 'DataCite',
                            metadata: normalizarMetadatosDataCite(data.data)
                        };
                    }
                }
            } catch (error) {
                console.log('DataCite fall칩:', error.message);
            }
            
            // 3. Intentar con OpenAlex
            try {
                const openAlexUrl = `https://api.openalex.org/works/https://doi.org/${doi}`;
                const response = await fetch(openAlexUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        return {
                            success: true,
                            source: 'OpenAlex',
                            metadata: normalizarMetadatosOpenAlex(data)
                        };
                    }
                }
            } catch (error) {
                console.log('OpenAlex fall칩:', error.message);
            }
            
            return {
                success: false,
                doiExists: false,
                message: 'No se pudo encontrar el DOI en ninguna fuente (Crossref, DataCite, OpenAlex)'
            };
        }

        /**
         * Normaliza metadatos de Crossref
         */
        function normalizarMetadatosCrossref(data) {
            return {
                titulo: data.title ? data.title[0] : '',
                autores: data.author || [],
                revista: data['container-title'] ? data['container-title'][0] : '',
                editorial: data.publisher || '',
                fecha: extraerAnioPublicacion(data),
                doi: data.DOI,
                tipo: data.type || '',
                metadatosOriginales: data
            };
        }

        /**
         * Normaliza metadatos de DataCite
         */
        function normalizarMetadatosDataCite(data) {
            const attrs = data.attributes || {};
            const autores = (attrs.creators || []).map(creator => ({
                given: creator.givenName || '',
                family: creator.familyName || creator.name || '',
                affiliation: creator.affiliation || []
            }));
            
            return {
                titulo: attrs.titles && attrs.titles[0] ? attrs.titles[0].title : '',
                autores: autores,
                revista: attrs.container && attrs.container.title ? attrs.container.title : '',
                editorial: attrs.publisher || '',
                fecha: attrs.publicationYear || (attrs.published ? new Date(attrs.published).getFullYear() : ''),
                doi: attrs.doi,
                tipo: attrs.types && attrs.types.resourceTypeGeneral ? attrs.types.resourceTypeGeneral : '',
                metadatosOriginales: data
            };
        }

        /**
         * Normaliza metadatos de OpenAlex
         */
        function normalizarMetadatosOpenAlex(data) {
            const autores = (data.authorships || []).map(authorship => {
                const author = authorship.author || {};
                const displayName = author.display_name || '';
                const nameParts = displayName.split(' ');
                
                return {
                    given: nameParts.slice(0, -1).join(' '),
                    family: nameParts[nameParts.length - 1] || '',
                    affiliation: authorship.institutions ? authorship.institutions.map(inst => ({
                        name: inst.display_name
                    })) : []
                };
            });
            
            const primaryLocation = data.primary_location || {};
            const source = primaryLocation.source || {};
            
            return {
                titulo: data.title || '',
                autores: autores,
                revista: source.display_name || '',
                editorial: source.host_organization_name || '',
                fecha: data.publication_year || '',
                doi: data.doi ? data.doi.replace('https://doi.org/', '') : '',
                tipo: data.type || '',
                metadatosOriginales: data
            };
        }

        /**
         * Extrae el a침o de publicaci칩n
         */
        function extraerAnioPublicacion(metadata) {
            if (metadata.published && metadata.published['date-parts'] && metadata.published['date-parts'][0]) {
                return metadata.published['date-parts'][0][0];
            } else if (metadata.issued && metadata.issued['date-parts'] && metadata.issued['date-parts'][0]) {
                return metadata.issued['date-parts'][0][0];
            } else if (metadata['published-online'] && metadata['published-online']['date-parts'] && metadata['published-online']['date-parts'][0]) {
                return metadata['published-online']['date-parts'][0][0];
            }
            return '';
        }

        /**
         * Muestra formulario para ingreso manual
         */
        function mostrarFormularioManual(doi, allowEdit = false) {
            const readonlyAttr = allowEdit ? '' : 'readonly';
            const bgClass = allowEdit ? 'bg-white focus:ring-2 focus:ring-amber-500' : 'bg-gray-50';
            const title = allowEdit ? 'Ingreso Manual de Datos' : 'No se pudieron obtener metadatos autom치ticamente';
            const message = allowEdit 
                ? 'Por favor, complete los datos de su publicaci칩n manualmente.' 
                : 'El DOI no se encontr칩 en Crossref, DataCite ni OpenAlex. Por favor, ingrese manualmente los datos:';

            return `
                <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                    <div class="flex gap-2 mb-3">
                        <svg class="w-6 h-6 text-amber-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div class="flex-grow">
                            <h3 class="font-bold text-amber-900 mb-1">${title}</h3>
                            <p class="text-sm text-amber-800 mb-2">${message}</p>
                        </div>
                    </div>
                </div>
                
                <form id="formManual" class="space-y-3 bg-white border-2 border-gray-300 rounded-lg p-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">DOI ${allowEdit ? '(Opcional)' : '*'}</label>
                        <input type="text" id="manualDOI" value="${doi}" ${readonlyAttr} class="w-full px-3 py-2 text-sm border border-gray-300 rounded ${bgClass}" placeholder="${allowEdit ? 'Dejar en blanco si no tiene DOI' : ''}">
                        ${allowEdit ? '<p class="text-xs text-gray-500 mt-1">Si no cuenta con DOI, puede dejar este campo en blanco o ingresar otro identificador.</p>' : ''}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T칤tulo del Art칤culo *</label>
                        <textarea id="manualTitulo" required rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="T칤tulo completo"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Autores (uno por l칤nea) *</label>
                        <textarea id="manualAutores" required rows="4" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="Nombre Apellido&#10;Otro Autor"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Ingrese cada autor en una l칤nea separada</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Revista *</label>
                            <input type="text" id="manualRevista" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Editorial *</label>
                            <input type="text" id="manualEditorial" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">A침o de Publicaci칩n *</label>
                        <input type="number" id="manualAnio" required min="1900" max="2100" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-amber-500" placeholder="2024">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button type="button" onclick="location.reload()" class="flex-1 bg-gray-700 text-white font-medium px-4 py-2 text-sm rounded hover:bg-gray-800 transition">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 btn-gold text-white font-semibold px-4 py-2 text-sm rounded">
                            Usar estos datos
                        </button>
                    </div>
                </form>
            `;
        }

        /**
         * Procesa datos manuales
         */
        function procesarDatosManual(doiOriginal) {
            // Esperar a que el DOM est칠 listo
            setTimeout(() => {
                const form = document.getElementById('formManual');
                if (!form) {
                    console.error('Formulario manual no encontrado');
                    return;
                }
                
                // Remover listeners anteriores clonando el elemento
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                newForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const titulo = document.getElementById('manualTitulo').value.trim();
                    const autoresTexto = document.getElementById('manualAutores').value.trim();
                    const revista = document.getElementById('manualRevista').value.trim();
                    const editorial = document.getElementById('manualEditorial').value.trim();
                    const anio = document.getElementById('manualAnio').value.trim();
                    
                    // Obtener DOI del input si es editable, o usar el original, o 'S/N'
                    const doiInput = document.getElementById('manualDOI');
                    const doiFinal = (doiInput && doiInput.value.trim()) ? doiInput.value.trim() : (doiOriginal || 'S/N');

                    const autoresLineas = autoresTexto.split('\n').filter(line => line.trim());
                    const autores = autoresLineas.map(linea => {
                        const partes = linea.trim().split(' ');
                        return {
                            given: partes.slice(0, -1).join(' ') || '',
                            family: partes[partes.length - 1] || linea.trim()
                        };
                    });
                    
                    const metadata = {
                        titulo: titulo,
                        autores: autores,
                        revista: revista,
                        editorial: editorial,
                        fecha: anio,
                        doi: doiFinal,
                        tipo: 'article',
                        metadatosOriginales: {
                            source: 'manual',
                            title: [titulo],
                            author: autores,
                            'container-title': [revista],
                            publisher: editorial,
                            DOI: doiFinal,
                            published: { 'date-parts': [[parseInt(anio)]] }
                        }
                    };
                    
                    metadatosPublicacion = metadata.metadatosOriginales;
                    autoresArticulo = autores;
                    
                    verificarDuplicadoYMostrarResultado(doiFinal, titulo, metadata, 'Ingreso Manual');
                });
            }, 100);
        }

        /**
         * Verifica duplicados y muestra resultado
         */
        async function verificarDuplicadoYMostrarResultado(doi, titulo, metadata, fuente) {
            const resultadoDiv = document.getElementById('resultado');
            
            resultadoDiv.innerHTML = `
                <div class="text-center text-gray-500 p-5 border-2 border-dashed border-gray-200 rounded-lg animate-pulse">
                    <p class="text-sm">Verificando disponibilidad del art칤culo...</p>
                </div>`;
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'checkDuplicate',
                        doi: doi,
                        titulo: titulo
                    }),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    }
                });
                
                const checkResult = await response.json();
                
                if (checkResult.data && checkResult.data.isDuplicate) {
                    mostrarArticuloDuplicado(checkResult.data.postulacionPrevia);
                } else {
                    mostrarResultadoExitoso(metadata, fuente);
                }
            } catch (error) {
                console.error('Error al verificar duplicado:', error);
                alert('Error al verificar disponibilidad. Por favor intente nuevamente.');
            }
        }

        /**
         * Muestra art칤culo duplicado
         */
        function mostrarArticuloDuplicado(prev) {
            const resultadoDiv = document.getElementById('resultado');
            const fechaFormateada = new Date(prev.fecha).toLocaleDateString('es-PE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            resultadoDiv.innerHTML = `
                <div class="bg-amber-50 p-4 rounded-lg border-2 border-amber-400">
                    <div class="flex items-start gap-3 mb-3">
                        <svg class="w-7 h-7 text-amber-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-amber-900 mb-1">Art칤culo ya postulado</h3>
                            <p class="text-amber-800 text-sm mb-3">Este art칤culo ya ha sido registrado y no puede postularse nuevamente.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-amber-200">
                        <h4 class="font-semibold text-gray-800 mb-2 text-sm">Postulaci칩n previa:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div><span class="font-medium text-gray-600">Fecha:</span><p class="text-gray-800">${fechaFormateada}</p></div>
                            <div><span class="font-medium text-gray-600">Estado:</span><p class="text-gray-800"><span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">${prev.estado || 'Pendiente'}</span></p></div>
                            <div><span class="font-medium text-gray-600">Postulante:</span><p class="text-gray-800">${prev.nombres} ${prev.apellidos}</p></div>
                            <div><span class="font-medium text-gray-600">Email:</span><p class="text-gray-800">${prev.email}</p></div>
                            <div class="md:col-span-2"><span class="font-medium text-gray-600">DOI:</span><p class="text-gray-800">${prev.doi}</p></div>
                            <div class="md:col-span-2"><span class="font-medium text-gray-600">T칤tulo:</span><p class="text-gray-800">${prev.titulo}</p></div>
                        </div>
                    </div>
                    <button onclick="location.reload()" class="mt-3 w-full bg-gray-700 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-gray-800 transition text-sm">Buscar otro art칤culo</button>
                </div>
            `;
        }

        /**
         * Muestra resultado exitoso
         */
        function mostrarResultadoExitoso(metadata, fuente) {
            const resultadoDiv = document.getElementById('resultado');
            
            document.getElementById('publicacionTitulo').value = metadata.titulo;
            document.getElementById('publicacionAutores').value = JSON.stringify(metadata.autores);
            document.getElementById('publicacionDOI').value = metadata.doi;
            document.getElementById('publicacionRevista').value = metadata.revista;
            document.getElementById('publicacionEditorial').value = metadata.editorial;
            document.getElementById('publicacionFecha').value = metadata.fecha;
            document.getElementById('publicacionMetadatos').value = JSON.stringify(metadata.metadatosOriginales);

            const autoresTexto = metadata.autores.map(a => `${a.given || ''} ${a.family || ''}`.trim()).join(', ') || 'N/A';
            
            resultadoDiv.innerHTML = `
                <div class="bg-teal-50 p-4 rounded-lg border border-teal-300">
                    <div class="flex items-start gap-2 mb-3">
                        <svg class="w-5 h-5 text-teal-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <div class="flex-grow">
                            <p class="text-xs text-teal-700 font-medium mb-1">Metadatos desde: <span class="font-bold">${fuente}</span></p>
                        </div>
                    </div>
                    <h3 class="text-base font-bold text-gray-800 mb-2">${metadata.titulo || 'Sin t칤tulo'}</h3>
                    <p class="text-gray-700 mb-1.5 text-sm"><strong>Autores:</strong> ${autoresTexto}</p>
                    <p class="text-gray-700 mb-1.5 text-sm"><strong>Revista:</strong> ${metadata.revista || 'N/A'}</p>
                    <p class="text-gray-700 mb-1.5 text-sm"><strong>Editorial:</strong> ${metadata.editorial || 'N/A'}</p>
                    <p class="text-gray-700 mb-1.5 text-sm"><strong>A침o:</strong> ${metadata.fecha || 'N/A'}</p>
                    <p class="text-gray-700 text-sm"><strong>DOI:</strong> <a href="https://doi.org/${metadata.doi}" target="_blank" class="text-teal-700 hover:underline font-medium">${metadata.doi}</a></p>
                    <button onclick="continuarPostulacion()" class="mt-3 w-full btn-gold text-white font-semibold px-5 py-2.5 rounded-lg text-sm">Continuar con la postulaci칩n</button>
                </div>
                <details class="mt-3 bg-white rounded-lg p-3 border">
                    <summary class="cursor-pointer text-teal-700 font-medium hover:underline text-sm">Ver metadatos completos</summary>
                    <div class="mt-4">${renderAllMetadataAsTable(metadata.metadatosOriginales)}</div>
                </details>
            `;
        }

        window.mostrarFormularioManualDirecto = function(doi = '') {
            const resultadoDiv = document.getElementById('resultado');
            const allowEdit = !doi; // Si no hay DOI, permitir edici칩n
            resultadoDiv.innerHTML = mostrarFormularioManual(doi, allowEdit);
            procesarDatosManual(doi);
        };

        window.iniciarIngresoManual = function() {
            mostrarFormularioManualDirecto('');
        };

        // ==================================================================
        // MANEJO DE B칔SQUEDA DOI
        // ==================================================================
        document.getElementById('doiForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            let doiInput = document.getElementById('doiInput').value.trim();
            const doiRegex = /(10\.\d{4,9}\/[-._;()/:A-Z0-9]+)/i;
            const match = doiInput.match(doiRegex);

            const resultadoDiv = document.getElementById('resultado');

            if (!match) {
                resultadoDiv.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                        <p class="font-bold">DOI no v치lido</p>
                        <p>Formato correcto: 10.xxxx/xxxxx</p>
                    </div>`;
                return;
            }

            const doi = match[0];
            
            resultadoDiv.innerHTML = `
                <div class="text-center text-gray-500 p-5 border-2 border-dashed border-gray-200 rounded-lg animate-pulse">
                    <p class="text-sm font-medium mb-2">Buscando metadatos en m칰ltiples fuentes...</p>
                    <p class="text-xs text-gray-400">Cross ref  DataCite  OpenAlex</p>
                </div>`;

            try {
                const resultado = await buscarMetadatosDOI(doi);
                
                if (resultado.success) {
                    metadatosPublicacion = resultado.metadata.metadatosOriginales;
                    autoresArticulo = resultado.metadata.autores;
                    verificarDuplicadoYMostrarResultado(doi, resultado.metadata.titulo, resultado.metadata, resultado.source);
                } else {
                    resultadoDiv.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                            <div class="flex gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1.293-9.293a1 1 0 011.414 0L10 10.586l1.293-1.293a1 1 0 011.414 1.414L11.414 10l1.293 1.293a1 1 0 01-1.414 1.414L10 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L8.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-grow">
                                    <p class="font-bold text-red-900">DOI no encontrado</p>
                                    <p class="text-sm text-red-800 mt-1">El DOI <code class="bg-red-100 px-1 rounded">${doi}</code> no se encontr칩 en Crossref, DataCite ni OpenAlex.</p>
                                    <div class="mt-3 p-2 bg-red-100 rounded text-xs">
                                        <p class="font-semibold mb-1">Posibles razones:</p>
                                        <ul class="list-disc list-inside space-y-0.5 ml-2">
                                            <li>DOI incompleto o con errores</li>
                                            <li>Art칤culo no publicado oficialmente</li>
                                            <li>DOI no registrado correctamente</li>
                                        </ul>
                                    </div>
                                    <div class="mt-3 flex gap-2">
                                        <button onclick="location.reload()" class="flex-1 bg-red-700 text-white px-3 py-2 text-xs rounded hover:bg-red-800 transition font-medium">Verificar DOI</button>
                                        <button onclick="mostrarFormularioManualDirecto('${doi}')" class="flex-1 bg-gray-700 text-white px-3 py-2 text-xs rounded hover:bg-gray-800 transition font-medium">Ingresar manualmente</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                resultadoDiv.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg">
                        <p class="font-bold">Error al buscar</p>
                        <p class="text-sm">${error.message}</p>
                    </div>`;
            }
        });

        // Funciones de navegaci칩n
        window.continuarPostulacion = function() {
            document.getElementById('seccionBusqueda').classList.add('hidden');
            document.getElementById('seccionPostulante').classList.remove('hidden');
            actualizarProgreso(2);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.continuarAutores = function() {
            // Validar campos del postulante
            const form = document.getElementById('formularioPostulacion');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Generar lista de autores
            generarListaAutores();
            
            document.getElementById('seccionPostulante').classList.add('hidden');
            document.getElementById('seccionAutores').classList.remove('hidden');
            document.getElementById('seccionEnvio').classList.remove('hidden');
            actualizarProgreso(3);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.volverBusqueda = function() {
            document.getElementById('seccionPostulante').classList.add('hidden');
            document.getElementById('seccionBusqueda').classList.remove('hidden');
            actualizarProgreso(1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.volverDatosPostulante = function() {
            document.getElementById('seccionAutores').classList.add('hidden');
            document.getElementById('seccionEnvio').classList.add('hidden');
            document.getElementById('seccionPostulante').classList.remove('hidden');
            actualizarProgreso(2);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.nuevaPostulacion = function() {
            document.getElementById('mensajeExito').classList.add('hidden');
            document.getElementById('seccionBusqueda').classList.remove('hidden');
            document.getElementById('formularioPostulacion').reset();
            document.getElementById('doiForm').reset();
            document.getElementById('resultado').innerHTML = `
                <div class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-200 rounded-lg">
                    <p>Los resultados de la b칰squeda aparecer치n aqu칤.</p>
                </div>`;
            metadatosPublicacion = null;
            autoresArticulo = [];
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Manejo del env칤o de postulaci칩n
        window.enviarPostulacion = async function() {
            // Verificar fecha l칤mite antes de enviar
            if (verificarFechaLimite()) {
                alert('Lo sentimos, el plazo de postulaci칩n ha finalizado.');
                mostrarFormularioCerrado();
                return;
            }
            
            const btnEnviar = document.getElementById('btnEnviar');
            
            try {
                // Validar que el PDF de declaraci칩n jurada est칠 cargado
                const pdfDeclaracionJurada = document.getElementById('pdfDeclaracionJurada').files[0];
                if (!pdfDeclaracionJurada) {
                    alert('Por favor, cargue el PDF de la Declaraci칩n Jurada');
                    return;
                }
                if (pdfDeclaracionJurada.size > 10 * 1024 * 1024) {
                    alert('El PDF de la Declaraci칩n Jurada no debe superar 10 MB');
                    return;
                }
                
                // Validar que todos los autores tengan afiliaci칩n declarada seleccionada
                for (let i = 0; i < autoresArticulo.length; i++) {
                    const afiliacionDeclarada = document.getElementById(`afiliacionDeclarada_${i}`).value;
                    
                    if (!afiliacionDeclarada) {
                        alert(`Por favor, seleccione la afiliaci칩n declarada para el autor ${i + 1}`);
                        return;
                    }
                    
                    // Solo validar campos adicionales si la afiliaci칩n es UNCP
                    if (afiliacionDeclarada === 'UNCP') {
                        const vinculoLaboral = document.getElementById(`vinculoLaboral_${i}`).value;
                        
                        if (!vinculoLaboral) {
                            alert(`Por favor, seleccione el v칤nculo con la UNCP para el autor ${i + 1}`);
                            return;
                        }
                        
                        // Si tiene v칤nculo laboral UNCP, validar que tenga PDF
                        if (vinculoLaboral === 'UNCP') {
                            const pdfFile = document.getElementById(`pdfAutor_${i}`).files[0];
                            
                            if (pdfFile && pdfFile.size > 10 * 1024 * 1024) {
                                alert(`El PDF del autor ${i + 1} no debe superar 10 MB`);
                                return;
                            }
                        }
                    }
                }
                
                // Validar que al menos un autor tenga afiliaci칩n UNCP o v칤nculo laboral UNCP
                if (!validarAlMenosUnAutorUNCP()) {
                    alert('Debe haber al menos un autor con afiliaci칩n UNCP declarada en el art칤culo o con v칤nculo vigente con la UNCP');
                    return;
                }
                
                // Validar que al menos un autor est칠 marcado como corresponsal
                if (!validarAlMenosUnCorresponsal()) {
                    // Mostrar advertencia visual
                    const advertenciaDiv = document.getElementById('advertenciaCorresponsal');
                    if (!advertenciaDiv) {
                        const nuevaAdvertencia = document.createElement('div');
                        nuevaAdvertencia.id = 'advertenciaCorresponsal';
                        nuevaAdvertencia.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-4';
                        nuevaAdvertencia.innerHTML = `
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="flex-grow">
                                    <h3 class="text-base font-bold text-red-900 mb-1">Autor Corresponsal Requerido</h3>
                                    <p class="text-red-800 text-sm">Toda publicaci칩n cient칤fica debe tener al menos un <strong>autor corresponsal</strong>. Por favor, marque al menos un autor como corresponsal antes de enviar la postulaci칩n.</p>
                                </div>
                            </div>
                        `;
                        document.getElementById('listaAutores').insertAdjacentElement('beforebegin', nuevaAdvertencia);
                        
                        // Scroll hacia la advertencia
                        nuevaAdvertencia.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
                
                // Remover advertencia si existe
                const advertenciaExistente = document.getElementById('advertenciaCorresponsal');
                if (advertenciaExistente) {
                    advertenciaExistente.remove();
                }
                
                // Mostrar ventana de confirmaci칩n con resumen
                if (!await mostrarResumenConfirmacion()) {
                    return; // Usuario cancel칩
                }
                
                btnEnviar.disabled = true;
                btnEnviar.textContent = 'Enviando...';
                
                mostrarModalProgreso('Subiendo Declaraci칩n Jurada...', 10);
                
                // Subir PDF de Declaraci칩n Jurada primero (temporal, se renombrar치 despu칠s)
                try {
                    const pdfBase64 = await fileToBase64(pdfDeclaracionJurada);
                    const tempFileName = `temp_dj_${Date.now()}.pdf`;
                    
                    console.log(`Subiendo DJ: ${tempFileName}, Tama침o: ${(pdfBase64.length / 1024).toFixed(2)} KB`);
                    
                    const uploadResponse = await fetchConTimeout(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'uploadFile',
                            fileData: pdfBase64.split(',')[1],
                            fileName: tempFileName
                        }),
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        }
                    }, 90000, 2); // 90 segundos, 2 intentos
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Error HTTP ${uploadResponse.status}: ${errorText}`);
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    console.log('DJ Upload result:', uploadResult);
                    
                    if (uploadResult.success) {
                        document.getElementById('pdfDeclaracionJuradaId').value = uploadResult.data.fileId;
                        document.getElementById('pdfDeclaracionJuradaUrl').value = uploadResult.data.fileUrl;
                        console.log('PDF Declaraci칩n Jurada subido:', uploadResult.data.fileId);
                    } else {
                        throw new Error(`Error al subir PDF: ${uploadResult.message}`);
                    }
                } catch (uploadError) {
                    console.error('Error completo al subir Declaraci칩n Jurada:', uploadError);
                    throw new Error(`Error al subir Declaraci칩n Jurada: ${uploadError.message}. Por favor, intente con un archivo m치s peque침o o verifique su conexi칩n.`);
                }
                
                actualizarProgreso('Preparando datos de autores...', 25);
                
                // Recopilar datos de autores con sus PDFs
                const autoresConDatos = [];
                for (let i = 0; i < autoresArticulo.length; i++) {
                    const autor = autoresArticulo[i];
                    const afiliacionDeclarada = document.getElementById(`afiliacionDeclarada_${i}`).value;
                    const esAutorCorresponsal = document.getElementById(`autorCorresponsal_${i}`).checked;
                    
                    const autorData = {
                        nombre: `${autor.given || ''} ${autor.family || ''}`.trim(),
                        afiliacionDeclarada: afiliacionDeclarada,
                        esAutorCorresponsal: esAutorCorresponsal,
                        datosOriginales: autor
                    };
                    
                    // Solo procesar campos adicionales si la afiliaci칩n es UNCP
                    if (afiliacionDeclarada === 'UNCP') {
                        const vinculoLaboral = document.getElementById(`vinculoLaboral_${i}`).value;
                        
                        autorData.vinculoLaboral = vinculoLaboral;
                        
                        // Si tiene v칤nculo laboral UNCP, subir PDF primero
                        if (vinculoLaboral === 'UNCP') {
                            const pdfFile = document.getElementById(`pdfAutor_${i}`).files[0];
                            
                            if (pdfFile) {
                                const progresoAutor = 25 + Math.floor((i + 1) / autoresArticulo.length * 40);
                                actualizarProgreso(`Subiendo PDF del autor ${i + 1} de ${autoresArticulo.length}...`, progresoAutor);
                                
                                try {
                                    // A침adir delay m치s largo entre uploads para evitar sobrecarga
                                    if (i > 0) {
                                        await new Promise(resolve => setTimeout(resolve, 2000));
                                    }
                                    
                                    const pdfBase64 = await fileToBase64(pdfFile);
                                    const fileName = `autor_${i + 1}_${Date.now()}_${pdfFile.name}`;
                                    
                                    console.log(`Subiendo PDF autor ${i + 1}: ${fileName}, Tama침o: ${(pdfFile.size / 1024).toFixed(2)} KB`);
                                    
                                    // Subir PDF individualmente con timeout y reintentos
                                    const uploadResponse = await fetchConTimeout(GOOGLE_SCRIPT_URL, {
                                        method: 'POST',
                                        body: JSON.stringify({
                                            action: 'uploadFile',
                                            fileData: pdfBase64.split(',')[1], // Remover prefijo data:
                                            fileName: fileName
                                        }),
                                        headers: {
                                            'Content-Type': 'text/plain;charset=utf-8',
                                        }
                                    }, 90000, 2); // 90 segundos, 2 intentos
                                    
                                    console.log(`Response status autor ${i + 1}: ${uploadResponse.status}`);
                                    
                                    if (!uploadResponse.ok) {
                                        const errorText = await uploadResponse.text();
                                        console.error(`Error response autor ${i + 1}:`, errorText);
                                        throw new Error(`Error HTTP ${uploadResponse.status}: ${errorText}`);
                                    }
                                    
                                    const uploadResult = await uploadResponse.json();
                                    console.log('Upload result:', uploadResult);
                                    
                                    if (uploadResult.success) {
                                        autorData.pdfId = uploadResult.data.fileId;
                                        autorData.pdfUrl = uploadResult.data.fileUrl;
                                        autorData.pdfFileName = uploadResult.data.fileName;
                                        console.log(`PDF ${i + 1} subido correctamente: ${uploadResult.data.fileId}`);
                                    } else {
                                        throw new Error(`Error al subir PDF: ${uploadResult.message}`);
                                    }
                                } catch (uploadError) {
                                    console.error(`Error completo autor ${i + 1}:`, uploadError);
                                    throw new Error(`Error al subir PDF del autor ${i + 1}: ${uploadError.message}`);
                                }
                            }
                        }
                    } else {
                        // Para autores externos, solo establecer v칤nculo como EXTERNO
                        autorData.vinculoLaboral = 'EXTERNO';
                    }
                    
                    autoresConDatos.push(autorData);
                }
                
                // Preparar datos completos (sin los PDFs en Base64, solo las referencias)
                const formData = {
                    action: 'submitForm',
                    nombres: document.getElementById('nombres').value,
                    apellidos: document.getElementById('apellidos').value,
                    email: document.getElementById('email').value,
                    pdfDeclaracionJurada: {
                        fileId: document.getElementById('pdfDeclaracionJuradaId').value,
                        fileUrl: document.getElementById('pdfDeclaracionJuradaUrl').value
                    },
                    publicacion: {
                        titulo: document.getElementById('publicacionTitulo').value,
                        autores: autoresConDatos,
                        doi: document.getElementById('publicacionDOI').value,
                        revista: document.getElementById('publicacionRevista').value,
                        editorial: document.getElementById('publicacionEditorial').value,
                        fecha: document.getElementById('publicacionFecha').value,
                        metadatosCompletos: metadatosPublicacion
                    }
                };
                
                // Enviar a Google Apps Script
                actualizarProgreso('Guardando postulaci칩n en el servidor...', 70);
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    actualizarProgreso('춰Postulaci칩n completada!', 100);
                    
                    // Esperar un momento para que se vea el 100%
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    // Ocultar modal y mostrar 칠xito
                    ocultarModalProgreso();
                    document.getElementById('seccionAutores').classList.add('hidden');
                    document.getElementById('seccionEnvio').classList.add('hidden');
                    document.getElementById('mensajeExito').classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error:', error);
                ocultarModalProgreso();
                alert('Error al enviar la postulaci칩n: ' + error.message);
                btnEnviar.disabled = false;
                btnEnviar.textContent = 'Enviar Postulaci칩n';
            }
        };

        /**
         * Convierte un archivo a Base64
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Fetch con timeout y reintentos
         */
        async function fetchConTimeout(url, options, timeoutMs = 60000, intentos = 2) {
            for (let intento = 1; intento <= intentos; intento++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    return response;
                    
                } catch (error) {
                    console.log(`Intento ${intento} fall칩:`, error.message);
                    
                    if (intento === intentos) {
                        throw new Error(`Error despu칠s de ${intentos} intentos: ${error.message}`);
                    }
                    
                    // Esperar antes de reintentar
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
    </script>

</body>
</html>
